<?xml version="1.0" encoding="utf-8"?>
<!--
 - Copyright 2021-2025 SanteSuite Contributors (See NOTICE.md for full copyright notices)
 - Portions Copyright (C) 2019 - 2021, Fyfe Software Inc. and the SanteSuite Contributors
 - Portions Copyright (C) 2015-2018 Mohawk College of Applied Arts and Technology
 - 
 - Licensed under the Apache License, Version 2.0 (the "License"); you 
 - may not use this file except in compliance with the License. You may 
 - obtain a copy of the License at 
 - 
 - http://www.apache.org/licenses/LICENSE-2.0 
 - 
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 - WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the 
 - License for the specific language governing permissions and limitations under 
 - the License.
 -->
<BiDataFlowDefinition xmlns="http://santedb.org/bi" id="org.santedb.bi.datamart.core.persons">
  <parameters>
    <ref name="input" />
    <ref name="output" />
  </parameters>
  <pipeline>
    <log name="log_start" priority="Verbose">Start Persons {{input}}</log>
    <reader name="input_psns_src">
      <connection ref="input" />
      <sql>
        <add>
          <providers>
            <invariant>sqlite</invariant>
          </providers>
          <![CDATA[
            SELECT DISTINCT
              ent_vrsn_tbl.ent_id,
              CASE WHEN POL.POL_ID IS NOT NULL THEN 'XXXX' ELSE home.TEL_VAL END AS tel_home,
              CASE WHEN POL.POL_ID IS NOT NULL THEN 'XXXX' ELSE cell.TEL_VAL END AS tel_cell,
              CASE WHEN POL.POL_ID IS NOT NULL THEN 'XXXX' ELSE wrk.TEL_VAL END AS tel_work,
              CASE WHEN POL.POL_ID IS NOT NULL THEN unixepoch(strftime('%Y-%m-15', datetime(dob, 'unixepoch'))) ELSE psn_tbl.DOB END AS dob,
              CASE WHEN POL.POL_ID IS NOT NULL THEN unixepoch(strftime('%Y-%m-15', datetime(dob, 'unixepoch'))) ELSE psn_tbl.DCSD_UTC END AS DCSD_UTC,
              (gndr_cd_id) AS gender,
              (plt.LNG_CS) AS primary_language,
              CASE WHEN POL.POL_ID IS NOT NULL THEN x'12BF169B3E07A44EB6C5E1B93E8FD490' ELSE occ_cd_id END AS occupation,
              CASE WHEN POL.POL_ID IS NOT NULL THEN x'12BF169B3E07A44EB6C5E1B93E8FD490' ELSE vip_sts_cd_id END AS vip,
              CASE WHEN POL.POL_ID IS NOT NULL THEN x'12BF169B3E07A44EB6C5E1B93E8FD490' ELSE nat_cd_id END AS nationality,
              CASE WHEN POL.POL_ID IS NOT NULL THEN x'12BF169B3E07A44EB6C5E1B93E8FD490' ELSE mrtl_sts_cd_id END AS MARITAL_STS
            FROM 
              psn_tbl 
              INNER JOIN ent_vrsn_tbl USING (ent_vrsn_id)
              LEFT JOIN ent_tel_tbl home ON (home.ent_id = ENT_VRSN_tbl.ENT_ID AND home.OBSLT_VRSN_SEQ_ID IS NULL AND home.USE_CD_ID = x'C02F13F3DDAAB740B875961C40695389')
              LEFT JOIN ent_tel_tbl cell ON (cell.ent_id = ENT_VRSN_TBL.ent_id AND cell.OBSLT_VRSN_SEQ_ID IS NULL AND (cell.TYP_CD_ID  = x'E9A4C0C138424440B89B9C9798995B90' OR cell.USE_CD_ID = x'0EF961E139590E43861AF8E885CC353D'))
              LEFT JOIN ent_tel_tbl wrk ON (wrk.ENT_ID = ENT_VRSN_TBL.ENT_ID AND wrk.OBSLT_VRSN_SEQ_ID IS NULL AND wrk.USE_CD_ID = x'8EF0A6EA8EBB57449DC03A1555FADF5C')
              LEFT JOIN PSN_LNG_TBL PLT ON (plt.ent_id = ent_vrsn_tbl.ENT_ID AND plt.obslt_vrsn_Seq_id IS NULL AND plt.PREF_IND)
              LEFT JOIN ENT_POL_ASSOC_TBL POL ON (POL.ENT_ID = ent_vrsn_tbl.ENT_ID AND POL.OBSLT_VRSN_SEQ_ID IS NULL) 
            WHERE 
              ENT_VRSN_TBL.HEAD = TRUE
	           ]]>
        </add>
        <add>
          <providers>
            <invariant>npgsql</invariant>
          </providers>
          <![CDATA[
          SELECT DISTINCT
              ent_vrsn_tbl.ent_id,
              CASE WHEN POL.POL_ID IS NOT NULL THEN 'XXXX' ELSE home.TEL_VAL END AS tel_home,
              CASE WHEN POL.POL_ID IS NOT NULL THEN 'XXXX' ELSE cell.TEL_VAL END AS tel_cell,
              CASE WHEN POL.POL_ID IS NOT NULL THEN 'XXXX' ELSE wrk.TEL_VAL END AS tel_work,
              CASE WHEN POL.POL_ID IS NOT NULL THEN DATE_TRUNC('month', psn_tbl.dob) + '14 DAY'::INTERVAL ELSE psn_tbl.DOB END AS dob,
              CASE WHEN POL.POL_ID IS NOT NULL THEN DATE_TRUNC('month', psn_tbl.DCSD_UTC) + '14 DAY'::INTERVAL ELSE psn_tbl.DCSD_UTC END AS DCSD_UTC,
              (gndr_cd_id) AS gender,
              (plt.LNG_CS) AS primary_language,
              CASE WHEN POL.POL_ID IS NOT NULL THEN '9b16bf12-073e-4ea4-b6c5-e1b93e8fd490' ELSE occ_cd_id END AS occupation,
              CASE WHEN POL.POL_ID IS NOT NULL THEN '9b16bf12-073e-4ea4-b6c5-e1b93e8fd490' ELSE vip_sts_cd_id END AS vip,
              CASE WHEN POL.POL_ID IS NOT NULL THEN '9b16bf12-073e-4ea4-b6c5-e1b93e8fd490' ELSE nat_cd_id END AS nationality,
              CASE WHEN POL.POL_ID IS NOT NULL THEN '9b16bf12-073e-4ea4-b6c5-e1b93e8fd490' ELSE mrtl_sts_cd_id END AS MARITAL_STS
            FROM 
              psn_tbl 
              INNER JOIN ent_vrsn_tbl USING (ent_vrsn_id)
              LEFT JOIN ent_tel_tbl home ON (home.ent_id = ENT_VRSN_tbl.ENT_ID AND home.OBSLT_VRSN_SEQ_ID IS NULL AND home.USE_CD_ID = 'f3132fc0-aadd-40b7-b875-961c40695389')
              LEFT JOIN ent_tel_tbl cell ON (cell.ent_id = ENT_VRSN_TBL.ent_id AND cell.OBSLT_VRSN_SEQ_ID IS NULL AND (cell.TYP_CD_ID  = 'c1c0a4e9-4238-4044-b89b-9c9798995b90' OR cell.USE_CD_ID = 'E161F90E-5939-430E-861A-F8E885CC353D'))
              LEFT JOIN ent_tel_tbl wrk ON (wrk.ENT_ID = ENT_VRSN_TBL.ENT_ID AND wrk.OBSLT_VRSN_SEQ_ID IS NULL AND wrk.USE_CD_ID = 'EAA6F08E-BB8E-4457-9DC0-3A1555FADF5C')
              LEFT JOIN PSN_LNG_TBL PLT ON (plt.ent_id = ent_vrsn_tbl.ENT_ID AND plt.obslt_vrsn_Seq_id IS NULL AND plt.PREF_IND)
              LEFT JOIN ENT_POL_ASSOC_TBL POL ON (POL.ENT_ID = ent_vrsn_tbl.ENT_ID AND POL.OBSLT_VRSN_SEQ_ID IS NULL) 
            WHERE 
              ENT_VRSN_TBL.HEAD = TRUE
          ]]>
        </add>
      </sql>
    </reader>
    <transform name="input_psns_map">
      <input ref="input_psns_src" />
      <map>
        <source name="ent_id" />
        <target name="ent_id" />
      </map>
      <map>
        <source name="tel_home" />
        <target name="tel_home" />
      </map>
      <map>
        <source name="tel_cell" />
        <target name="tel_cell" />
      </map>
      <map>
        <source name="tel_work" />
        <target name="tel_work" />
      </map>
      <map>
        <source name="dob" />
        <target name="dob" />
      </map>
      <map>
        <source name="dcsd_utc" />
        <target name="dcsd_utc" />
      </map>
      <map>
        <source name="gender">
          <concept />
        </source>
        <target name="gender" />
      </map>
      <map>
        <source name="primary_language" />
        <target name="primary_language" />
      </map>
      <map>
        <source name="occupation">
          <concept />
        </source>
        <target name="occupation" />
      </map>
      <map>
        <source name="vip">
          <concept />
        </source>
        <target name="vip" />
      </map>
      <map>
        <source name="nationality">
          <concept />
        </source>
        <target name="nationality" />
      </map>
      <map>
        <source name="marital_sts">
          <concept />
        </source>
        <target name="marital_sts" />
      </map>
    </transform>
    <distinct name="input_psns">
      <input ref="input_psns_map" />
      <on>ent_id</on>
    </distinct>
    <reader name="input_staff">
      <connection ref="input" />
      <sql>
        <add>
          <providers>
            <invariant>npgsql</invariant>
          </providers>
          <![CDATA[ 
            SELECT 
              ENT_REL_ID AS REL_ID, 
              SRC_ENT_ID AS PSN_ID, 
              TRG_ENT_ID AS PLC_ID
            FROM 
              ENT_REL_TBL
              INNER JOIN ENT_VRSN_TBL ON (SRC_ENT_ID = ENT_ID AND ENT_VRSN_TBL.CLS_CD_ID = '6a2b00ba-501b-4523-b57c-f96d8ae44684' AND HEAD AND OBSLT_UTC IS NULL)
            WHERE 
              REL_TYP_CD_ID = '455F1772-F580-47E8-86BD-B5CE25D351F9'
              AND OBSLT_VRSN_SEQ_ID IS NULL;
          ]]>
        </add>
        <add>
          <providers>
            <invariant>sqlite</invariant>
          </providers>
          <![CDATA[SELECT 
              ENT_REL_ID AS REL_ID, 
              SRC_ENT_ID AS PSN_ID, 
              TRG_ENT_ID AS PLC_ID
            FROM 
              ENT_REL_TBL
              INNER JOIN ENT_VRSN_TBL ON (SRC_ENT_ID = ENT_ID AND ENT_VRSN_TBL.CLS_CD_ID = x'BA002B6A1B502345B57CF96D8AE44684' AND HEAD AND OBSLT_UTC IS NULL)
            WHERE 
              REL_TYP_CD_ID = x'72175F4580F5E84786BDB5CE25D351F9'
              AND OBSLT_VRSN_SEQ_ID IS NULL;]]>
        </add>
      </sql>
    </reader>
    <reader name="input_uents">
      <connection ref="input" />
      <sql>
        <add>
          <providers>
            <invariant>npgsql</invariant>
            <invariant>sqlite</invariant>
          </providers>
          <![CDATA[
            SELECT DISTINCT ENT_VRSN_TBL.ENT_ID,
	            sec_usr_tbl.USR_NAME AS USERNAME
            FROM
	            usr_ent_tbl
	            INNER JOIN ent_vrsn_tbl USING (ent_vrsn_id)
	            INNER JOIN sec_usr_tbl ON (sec_usr_id = usr_id)
          ]]>
        </add>
      </sql>
    </reader>
    <reader name="input_pvdr">
      <connection ref="input" />
      <sql>
        <add>
          <providers>
            <invariant>sqlite</invariant>
          </providers>
          <![CDATA[
            SELECT DISTINCT ent_id,
	            cd_vrsn_tbl.mnemonic AS specialty,
	            CASE WHEN ent_rel_tbl.SRC_ENT_ID = ent_id THEN ent_rel_tbl.trg_ent_id ELSE ent_rel_tbl.src_ent_id END AS usr_id
            FROM 
	            PVDR_TBL
	            INNER JOIN ent_vrsn_tbl USING (ent_vrsn_id)
	            LEFT JOIN CD_VRSN_TBL ON (cd_vrsn_tbl.cd_id = pvdr_tbl.SPEC_CD_ID AND cd_vrsn_tbl.HEAD)
	            LEFT JOIN ent_rel_tbl ON (ent_rel_tbl.REL_TYP_CD_ID = x'DF4E5F395D5D50499F5EF827F72E4B32' AND ent_rel_tbl.CLS_CD_ID = x'BCEF7B8ED956F249A7587085CA72D03D' AND (src_ent_id = ent_vrsn_Tbl.ent_id OR trg_ent_id = ent_Vrsn_tbl.ent_id))    
            ]]>
        </add>
        <add>
          <providers>
            <invariant>npgsql</invariant>
          </providers>
        <![CDATA[
            SELECT DISTINCT ent_id,
	            cd_vrsn_tbl.mnemonic AS specialty,
	            CASE WHEN ent_rel_tbl.SRC_ENT_ID = ent_id THEN ent_rel_tbl.trg_ent_id ELSE ent_rel_tbl.src_ent_id END AS usr_id
            FROM 
	            PVDR_TBL
	            INNER JOIN ent_vrsn_tbl USING (ent_vrsn_id)
	            LEFT JOIN CD_VRSN_TBL ON (cd_vrsn_tbl.cd_id = pvdr_tbl.SPEC_CD_ID AND cd_vrsn_tbl.HEAD)
	            LEFT JOIN ent_rel_tbl ON (ent_rel_tbl.REL_TYP_CD_ID = '395F4EDF-5D5D-4950-9F5E-F827F72E4B32' AND ent_rel_tbl.CLS_CD_ID = '8E7BEFBC-56D9-49F2-A758-7085CA72D03D' AND (src_ent_id = ent_vrsn_Tbl.ent_id OR trg_ent_id = ent_Vrsn_tbl.ent_id))    
            ]]>
        </add>
      </sql>
    </reader>

    <writer name="output_psns" truncate="true" mode="insert">
      <input ref="input_psns" />
      <connection ref="output" />
      <target ref="PSN_TBL" />
    </writer>
    <writer name="output_uents" truncate="true" mode="insert">
      <input ref="input_uents" />
      <connection ref="output" />
      <target ref="USR_TBL" />
    </writer>
    <writer name="output_pvd" truncate="true" mode="insert">
      <input ref="input_pvdr" />
      <connection ref="output" />
      <target ref="PVD_TBL" />
    </writer>
    <writer name="output_staff" truncate="true" mode="insert">
      <input ref="input_staff" />
      <connection ref="output" />
      <target ref="PLC_STF_TBL" />
    </writer>
    <union name="union_psns">
      <input ref="output_psns" />
      <with ref="output_uents" />
      <with ref="output_pvd" />
      <with ref="output_staff" />
    </union>

    <filter name="filter_rejects">
      <input ref="union_psns" />
      <all>
        <when field="$reject" op="eq">
          <bool>true</bool>
        </when>
      </all>
    </filter>
    <transform name="transform_rejects">
      <input ref="filter_rejects" />
      <map>
        <source name="ENT_ID" />
        <target name="RECORD_ID" />
      </map>
      <map>
        <source>
          <fixed>PSN_TBL</fixed>
        </source>
        <target name="RECORD_TYP" />
      </map>
      <map>
        <source name="$reject.reason" />
        <target name="REASON" />
      </map>
    </transform>
    <writer name="write_rejects" truncate="false" mode="insertUpdate">
      <input ref="transform_rejects" />
      <connection ref="output" />
      <target ref="REJECT_TBL" />
    </writer>
    <filter name="filter_rejects2">
      <input ref="write_rejects" />
      <all>
        <when field="$reject" op="eq">
          <bool>true</bool>
        </when>
      </all>
    </filter>
    <halt name="halt_rejects">
      <input ref="filter_rejects2" />
    </halt>
  </pipeline>

</BiDataFlowDefinition>