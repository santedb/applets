<?xml version="1.0" encoding="utf-8" ?>
<!--
 - Portions Copyright 2015-2019 Mohawk College of Applied Arts and Technology
 - Portions Copyright 2019-2019 SanteSuite Contributors (See NOTICE)
 - 
 - 
 - Licensed under the Apache License, Version 2.0 (the "License"); you 
 - may not use this file except in compliance with the License. You may 
 - obtain a copy of the License at 
 - 
 - http://www.apache.org/licenses/LICENSE-2.0 
 - 
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 - WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the 
 - License for the specific language governing permissions and limitations under 
 - the License.
 - 
 - User: Justin Fyfe
 - Date: 2019-12-16
 -->
<BiQueryDefinition xmlns="http://santedb.org/bi" id="org.santedb.bi.core.query.patient" label="ui.santedb.bi.core.query.patient">
  <meta status="active">
    <authors>
      <add>Justin Fyfe (Fyfe Software Inc.) &lt;justin@fyfesoftware.ca></add>
    </authors>
    <annotation>
      <div xmlns="http://www.w3.org/1999/xhtml">
        <p>This query provides a view of all patient data in the SanteDB system</p>
      </div>
    </annotation>
  </meta>
  <dataSources>
    <add ref="#org.santedb.bi.dataSource.main"/>
  </dataSources>
  <parameters>
    <add ref="#org.santedb.bi.core.parameter.common.date.from" name="dob-from" type="date"/>
    <add ref="#org.santedb.bi.core.parameter.common.date.to" name="dob-to" type="date"/>
    <add ref="#org.santedb.bi.core.parameter.patient.gender" name="gender" type="uuid" />
  </parameters>
  <definitions>
    <add>
      <providers>
        <invariant>npgsql</invariant>
        <invariant>fbsql</invariant>
      </providers>
      <![CDATA[
        select 
          ent_id as id,
          dcsd_utc as death_time,
          mb_ord as multi_birth,
          dob as birth_time,
          gndr.mnemonic as gender,
          ent_vrsn_tbl.crt_utc as created_time,
          mrtl.mnemonic as marital_status,
          edu_lvl.mnemonic as edu_level,
          master.trg_ent_id as master_id
        from 
          pat_tbl 
          inner join psn_tbl using (ent_vrsn_id) 
          inner join ent_vrsn_tbl using (ent_vrsn_id) 
          inner join cd_vrsn_tbl gndr on (gndr_cd_id = gndr.cd_id and gndr.obslt_utc is null)
          left join ent_rel_tbl master on (src_ent_id = ent_id and rel_typ_cd_id = '97730a52-7e30-4dcd-94cd-fd532d111578' and obslt_vrsn_seq_id is null)
          left join cd_vrsn_tbl mrtl on (mrtl_sts_cd_id = mrtl.cd_id and mrtl.obslt_utc is null)
          left join cd_vrsn_tbl edu_lvl on (edu_lvl_cd_id = edu_lvl.cd_id and edu_lvl.obslt_utc is null)
        where 
          ent_vrsn_tbl.obslt_utc is null
          and dob between CAST(coalesce(${dob-from}, '0001-01-01') AS DATE) and CAST(coalesce(${dob-to}, current_date) AS DATE)
          and gndr_cd_id = COALESCE(${gender}, gndr_cd_id)
      ]]>
    </add>
    <add>
      <providers>
        <invariant>sqlite</invariant>
      </providers>
      <![CDATA[
      select 
        entity.uuid as id,
        deceasedDate as death_time,
        birth_order as multi_birth,
        dateOfBirth as birth_time,
        gender.mnemonic as gender,
        entity.creationTime as created_time,
        marital.mnemonic as marital_status,
        education.mnemonic as edu_level,
        entity.uuid as master_id
      from 
        patient 
        inner join person on (patient.uuid = person.uuid) 
        inner join entity on (patient.uuid = entity.uuid) 
        inner join concept as gender on (genderConcept = gender.uuid) 
        left join concept as marital on (marital.uuid = marital_status) 
        left join concept as education on (education.uuid = education_level)
      where
        (dateOfBirth - 621355968000000000) /  10000000  between coalesce(${dob-from},-0xfffffffffff) and coalesce(${dob-to}, 0xfffffffffff)
        and genderConcept = COALESCE(${gender}, genderConcept)
      ]]>
    </add>
  </definitions>
</BiQueryDefinition>